<%= form_with model:card,url:consumers_cards_path, id: "'charge-form'" do |f| %>

  <span class="charge-errors"></span>

  <h4>支払い</h4>
  <%= f.label :number, "カード番号"%>
  <%= f.text_field :number, class: "number", maxlength: "16", placehplder: "カード番号"%>

  <%= f.label :cvc, "CVC"%>
  <%= f.number_field :cvc, class: "cvc", maxlength: "3", placehplder: "CVC"%>

  <%= f.label :exp_month, "有効期限"%>
  <%= f.number_field :exp_month, class: "exp_month", maxlength: "2", placehplder: "月"%>
  <%= f.number_field :exp_year, class: "exp_year", maxlength: "4", placehplder: "年"%>

  <%= f.submit "送信" ,id: "regist_card"%>
  <div id="card_token"></div>
<% end %>

<script type="text/javascript">
(function() {
  var form = $("#charge-form"),
      number = form.find('input[name="number"]'),
      cvc = form.find('input[name="cvc"]'),
      exp_month = form.find('select[name="exp_month"]'),
      exp_year = form.find('input[name="exp_year"]');

  $("#charge-form").submit(function() {
    form.find("input[type=submit]").prop("disabled", true);

    var card = {
        number: number.value,
        cvc: cvc.value,
        exp_month: exp_month.value,
        exp_year: exp_year.value
    };
    Payjp.createToken(card, function(s, response) {
      if (response.error) {
        form.find('.payment-errors').text(response.error.message);
        form.find('button').prop('disabled', false);
      }
      else {
        $(".number").removeAttr("name");
        $(".cvc").removeAttr("name");
        $(".exp_month").removeAttr("name");
        $(".exp_year").removeAttr("name");

        var token = response.id;

        form.append($('<input type="hidden" name="payjpToken" />').val(token));
        form.get(0).submit();
      }
    });
  });
})();
</script>